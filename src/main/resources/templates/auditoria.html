<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Kaiadmin - Auditor√≠a de Productos</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
    <link rel="icon" th:href="@{/assets/img/kaiadmin/logocv.ico}" type="image/x-icon" />

    <!-- CDN Fallbacks for better reliability -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS Files -->
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/assets/css/plugins.min.css}" />
    <link rel="stylesheet" th:href="@{/assets/css/kaiadmin.min.css}" />

    <!-- CDN Bootstrap fallback -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha512-t4GWSVZO1eC8BM339Xd7Uphw5s17a86tIZIj8qRxhnKub6WoyhnrxeCIMeAqBPgdZGlCcG2PrZjMc+Wr78+5Xg=="
          crossorigin="anonymous" />

    <style>
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 0;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 14px;
        }

        .pagination-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-nav button {
            border: 1px solid #dee2e6;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-nav button:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        .pagination-nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-nav .page-input {
            width: 60px;
            text-align: center;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6c757d;
            font-size: 14px;
        }

        .page-size-selector select {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 5px 10px;
            background: white;
        }

        /* Estilos mejorados para filtros */
        .filters-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
            margin-bottom: 25px;
        }

        .filters-header {
            background: #1a2035;
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .filters-header h6 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filters-body {
            padding: 20px;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
            flex: 1;
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a2035;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-group .form-control {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .filter-group .form-control:focus {
            border-color: #1a2035;
            box-shadow: 0 0 0 0.2rem rgba(26, 32, 53, 0.25);
        }

        .filter-group .form-control::placeholder {
            color: #adb5bd;
            font-style: italic;
        }

        .date-range-group {
            display: flex;
            gap: 15px;
            align-items: end;
            min-width: 300px;
        }

        .date-input-wrapper {
            position: relative;
            flex: 1;
        }

        .date-input-wrapper .form-control {
            padding-left: 35px;
        }

        .date-input-wrapper .calendar-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 10;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: end;
            min-width: 120px;
        }

        .btn-filter-clear {
            background-color: #dc3545;
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-filter-clear:hover {
            background-color: #c82333;
            transform: translateY(-1px);
            color: white;
        }

        .btn-filter-refresh {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-filter-refresh:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
            color: white;
        }

        .movement-type-select {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 0.875rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 10px center;
            background-repeat: no-repeat;
            background-size: 16px;
            appearance: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .movement-type-select:focus {
            border-color: #1a2035;
            box-shadow: 0 0 0 0.2rem rgba(26, 32, 53, 0.25);
            outline: none;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                gap: 15px;
            }

            .filter-group {
                min-width: 100%;
            }

            .date-range-group {
                min-width: 100%;
                flex-direction: column;
                gap: 15px;
            }

            .filter-actions {
                min-width: 100%;
                justify-content: stretch;
            }

            .filter-actions button {
                flex: 1;
            }
        }

        /* Indicador de filtros activos */
        .active-filters-indicator {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #1976d2;
            display: none;
        }

        .active-filters-indicator.show {
            display: block;
        }

        /* Loading spinner */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        /* Table improvements */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .table th {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
        }

        .badge {
            font-size: 0.75em;
            padding: 0.375rem 0.75rem;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modal improvements */
        .modal-header {
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
        }

        .modal-content {
            border-radius: 8px;
            border: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .card {
            border-radius: 8px;
        }

        .alert {
            border-radius: 6px;
        }
    </style>

    <script th:inline="javascript">
        window.userRole = /*[[${userRole}]]*/ 'VISITOR';
        window.isAdmin = /*[[${isAdmin}]]*/ false;
    </script>
</head>
<body>
<div class="wrapper">
    <div th:replace="~{index :: sidebar}"></div>

    <div class="main-panel">
        <div th:replace="~{index :: main-header}"></div>

        <div class="container">
            <div class="page-inner">
                <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
                    <div>
                        <h3 class="fw-bold mb-3">Entradas y Salidas de Productos</h3>
                        <h6 class="op-7 mb-2">Registro de movimientos con fechas y usuarios responsables</h6>
                    </div>
                    <div class="ms-md-auto py-2 py-md-0">
                        <button class="btn btn-primary btn-round" id="refreshBtn">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>

                <!-- Filtros Mejorados -->
                <div class="filters-card">
                    <div class="filters-header">
                        <h6>
                            <i class="fas fa-filter"></i>
                            Filtros de B√∫squeda
                        </h6>
                        <button class="btn btn-sm btn-outline-light" id="toggleFiltersBtn">
                            <i class="fas fa-chevron-up" id="filterToggleIcon"></i>
                        </button>
                    </div>
                    <div class="filters-body" id="filtersBody">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="productFilter">
                                    <i class="fas fa-box text-primary"></i>
                                    Producto
                                </label>
                                <input type="text" id="productFilter" class="form-control"
                                       placeholder="Buscar por nombre de producto...">
                            </div>

                            <div class="filter-group">
                                <label for="userFilter">
                                    <i class="fas fa-user text-success"></i>
                                    Usuario Responsable
                                </label>
                                <input type="text" id="userFilter" class="form-control"
                                       placeholder="Buscar por usuario...">
                            </div>

                            <div class="filter-group">
                                <label for="movementFilter">
                                    <i class="fas fa-exchange-alt text-warning"></i>
                                    Tipo de Movimiento
                                </label>
                                <select id="movementFilter" class="movement-type-select">
                                    <option value="">üìã Todos los movimientos</option>
                                    <option value="stock_only">üì¶ Solo cambios de STOCK</option>
                                    <option value="creation">‚úÖ Solo entradas (creaci√≥n)</option>
                                    <option value="deletion">‚ùå Solo salidas (eliminaci√≥n)</option>
                                </select>
                            </div>

                            <div class="date-range-group">
                                <div class="filter-group">
                                    <label for="dateFrom">
                                        <i class="fas fa-calendar-alt text-info"></i>
                                        Fecha Desde
                                    </label>
                                    <div class="date-input-wrapper">
                                        <i class="fas fa-calendar calendar-icon"></i>
                                        <input type="date" id="dateFrom" class="form-control">
                                    </div>
                                </div>
                                <div class="filter-group">
                                    <label for="dateTo">
                                        <i class="fas fa-calendar-check text-info"></i>
                                        Fecha Hasta
                                    </label>
                                    <div class="date-input-wrapper">
                                        <i class="fas fa-calendar calendar-icon"></i>
                                        <input type="date" id="dateTo" class="form-control">
                                    </div>
                                </div>
                            </div>

                            <div class="filter-actions">
                                <button class="btn-filter-clear" id="clearFiltersBtn">
                                    <i class="fas fa-times"></i>
                                    Limpiar
                                </button>
                            </div>
                        </div>

                        <div class="active-filters-indicator" id="activeFiltersIndicator">
                            <i class="fas fa-info-circle"></i>
                            <span id="activeFiltersText">Filtros activos: </span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="card card-round">
                            <div class="card-header">
                                <div class="card-head-row">
                                    <div class="card-title">Historial de Movimientos</div>
                                    <div class="ms-md-auto py-2 py-md-0 me-3">
                                        <span class="text-muted" id="lastUpdated">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="auditTable" class="table table-striped table-hover">
                                        <thead>
                                        <tr>
                                            <th>Fecha/Hora</th>
                                            <th>Usuario Responsable</th>
                                            <th>Producto</th>
                                            <th>Tipo de Movimiento</th>
                                            <th>Acciones</th>
                                        </tr>
                                        </thead>
                                        <tbody id="auditTableBody">
                                        <!-- Los registros se cargar√°n aqu√≠ din√°micamente -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Controles de Paginaci√≥n -->
                                <div class="pagination-controls">
                                    <div class="pagination-info">
                                        <span id="paginationInfo">Mostrando 0 - 0 de 0 registros</span>
                                    </div>

                                    <div class="pagination-nav">
                                        <button id="firstPageBtn" title="Primera p√°gina">
                                            <i class="fas fa-angle-double-left"></i>
                                        </button>
                                        <button id="prevPageBtn" title="P√°gina anterior">
                                            <i class="fas fa-angle-left"></i>
                                        </button>

                                        <span>P√°gina</span>
                                        <input type="number" id="currentPageInput" class="page-input" min="1" value="1">
                                        <span>de <span id="totalPages">1</span></span>

                                        <button id="nextPageBtn" title="P√°gina siguiente">
                                            <i class="fas fa-angle-right"></i>
                                        </button>
                                        <button id="lastPageBtn" title="√öltima p√°gina">
                                            <i class="fas fa-angle-double-right"></i>
                                        </button>
                                    </div>

                                    <div class="page-size-selector">
                                        <span>Mostrar</span>
                                        <select id="pageSizeSelect">
                                            <option value="10" selected>10</option>
                                            <option value="25">25</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                        <span>por p√°gina</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="container-fluid d-flex justify-content-between">
                <nav class="pull-left">
                    <ul class="nav">
                        <li class="nav-item">
                            <a class="nav-link" href="http://www.themekita.com">ThemeKita</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Help</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Licenses</a>
                        </li>
                    </ul>
                </nav>
                <div class="copyright">
                    2024, made with <i class="fa fa-heart heart text-danger"></i> by
                    <a href="http://www.themekita.com">ThemeKita</a>
                </div>
                <div>
                    Distributed by
                    <a target="_blank" href="https://themewagon.com/">ThemeWagon</a>.
                </div>
            </div>
        </footer>
    </div>
</div>

<!-- Modal for movement details -->
<div class="modal fade" id="movementDetailModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-list me-2"></i>
                    Detalles del Movimiento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="movementDetailBody">
                <!-- Dynamic content loads here -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="text-muted mt-2">Cargando detalles...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Load jQuery first from CDN with fallback -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous"></script>

<!-- Fallback if CDN fails -->
<script>
    if (typeof jQuery === 'undefined') {
        document.write('<script src="/assets/js/core/jquery-3.7.1.min.js"><\/script>');
    }
</script>

<!-- Bootstrap JS from CDN with fallback -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"
        integrity="sha512-VK2zcvntEufaimc+efOYi622VN5ZacdnufnmX7zIhCPmjhKnOi9ZDMtg1/ug5l183f19gG1/cBstPO4y8Ck3Nw=="
        crossorigin="anonymous"></script>

<!-- Other JS Files -->
<script th:src="@{/assets/js/core/popper.min.js}"></script>
<script th:src="@{/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js}"></script>
<script th:src="@{/assets/js/plugin/datatables/datatables.min.js}"></script>
<script th:src="@{/assets/js/plugin/sweetalert/sweetalert.min.js}"></script>
<script th:src="@{/assets/js/kaiadmin.min.js}"></script>

<script>
    // Wait for jQuery to be fully loaded
    $(document).ready(function() {
        console.log('jQuery loaded successfully:', typeof $ !== 'undefined');
        console.log('Bootstrap loaded:', typeof bootstrap !== 'undefined');

        // Application state
        let currentPage = 0;
        let pageSize = 10;
        let totalElements = 0;
        let totalPages = 0;
        let filterTimeout;

        // Initialize the application
        initializeApp();

        function initializeApp() {
            console.log('Initializing audit application...');

            // Set up event listeners
            setupEventListeners();

            // Load initial data
            loadMovementData();
            updateLastUpdatedTime();
            updateActiveFiltersIndicator();

            console.log('Application initialized successfully');
        }

        function setupEventListeners() {
            // Refresh button
            $('#refreshBtn').on('click', function() {
                console.log('Refresh button clicked');
                refreshMovementData();
            });

            // Filter toggle
            $('#toggleFiltersBtn').on('click', function() {
                toggleFilters();
            });

            // Clear filters
            $('#clearFiltersBtn').on('click', function() {
                clearFilters();
            });

            // Pagination controls
            $('#firstPageBtn').on('click', function() { goToPage(0); });
            $('#prevPageBtn').on('click', function() { goToPage(currentPage - 1); });
            $('#nextPageBtn').on('click', function() { goToPage(currentPage + 1); });
            $('#lastPageBtn').on('click', function() { goToPage(totalPages - 1); });

            $('#currentPageInput').on('change', function() {
                const pageNumber = parseInt($(this).val()) - 1;
                if (pageNumber >= 0 && pageNumber < totalPages) {
                    goToPage(pageNumber);
                } else {
                    $(this).val(currentPage + 1);
                }
            });

            $('#pageSizeSelect').on('change', function() {
                pageSize = parseInt($(this).val());
                currentPage = 0;
                loadMovementData();
            });

            // Filter inputs with debounce
            $('.filter-row input, .filter-row select').on('input change', function() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(function() {
                    currentPage = 0;
                    loadMovementData();
                }, 500);
            });
        }

        function loadMovementData() {
            console.log('Loading movement data...');

            const filters = getFilters();
            let url;

            // Determine which endpoint to use based on filter
            if (filters.movementType === 'stock_only') {
                url = `/api/auditoria/products/stock-movements?page=${currentPage}&size=${pageSize}&sort=revision,desc`;
            } else {
                url = `/api/auditoria/products?page=${currentPage}&size=${pageSize}&sort=revision,desc`;
            }

            // Add common filters
            if (filters.productName) {
                url += `&productName=${encodeURIComponent(filters.productName)}`;
            }
            if (filters.username) {
                url += `&username=${encodeURIComponent(filters.username)}`;
            }
            if (filters.dateFrom) {
                url += `&dateFrom=${filters.dateFrom}T00:00:00`;
            }
            if (filters.dateTo) {
                url += `&dateTo=${filters.dateTo}T23:59:59`;
            }

            // Add specific filters for original endpoint
            if (filters.movementType === 'creation') {
                url += `&revType=0`;
            } else if (filters.movementType === 'deletion') {
                filteredData = sampleData.filter(record => record.revType === 2);
            }

            console.log('API URL:', url);

            $.ajax({
                url: url,
                type: 'GET',
                success: function(response) {
                    console.log('Data loaded successfully:', response);
                    renderMovementData(response.content);
                    updatePaginationInfo(response);
                    updateLastUpdatedTime();
                    updateActiveFiltersIndicator();
                },
                error: function(xhr, status, error) {
                    console.error('Error loading data:', error);
                    console.log('Using sample data instead');
                }
            });
        }

        function getFilters() {
            return {
                productName: $('#productFilter').val().trim(),
                username: $('#userFilter').val().trim(),
                dateFrom: $('#dateFrom').val(),
                dateTo: $('#dateTo').val(),
                movementType: $('#movementFilter').val()
            };
        }

        function updateActiveFiltersIndicator() {
            const filters = getFilters();
            const activeFilters = [];

            if (filters.productName) activeFilters.push(`Producto: "${filters.productName}"`);
            if (filters.username) activeFilters.push(`Usuario: "${filters.username}"`);
            if (filters.dateFrom) activeFilters.push(`Desde: ${filters.dateFrom}`);
            if (filters.dateTo) activeFilters.push(`Hasta: ${filters.dateTo}`);
            if (filters.movementType) {
                const movementText = $('#movementFilter option:selected').text();
                activeFilters.push(`Tipo: ${movementText}`);
            }

            const indicator = $('#activeFiltersIndicator');
            const indicatorText = $('#activeFiltersText');

            if (activeFilters.length > 0) {
                indicatorText.text(`Filtros activos: ${activeFilters.join(', ')}`);
                indicator.addClass('show');
            } else {
                indicator.removeClass('show');
            }
        }

        function renderMovementData(records) {
            const tableBody = $('#auditTableBody');
            tableBody.empty();

            if (records.length === 0) {
                tableBody.append(`
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        <i class="fas fa-info-circle fa-2x mb-2 d-block"></i>
                        No se encontraron movimientos
                    </td>
                </tr>
            `);
                return;
            }

            records.forEach(record => {
                const formattedDate = formatDateTime(record.revisionDate);
                const movementBadge = getMovementBadge(record.revType, record.productName);

                const row = `
                <tr>
                    <td>${formattedDate}</td>
                    <td>
                        <i class="fas fa-user text-primary me-1"></i>
                        ${record.username || 'Sistema'}
                    </td>
                    <td>
                        <i class="fas fa-box text-success me-1"></i>
                        ${record.productName || 'N/A'}
                    </td>
                    <td>${movementBadge}</td>
                    <td>
                        <button class="btn btn-info btn-sm btn-icon"
                                onclick="showMovementDetail(${record.revision}, ${record.productId}, '${escapeQuotes(record.productName || '')}', ${record.revType}, '${escapeQuotes(record.username || 'Sistema')}', '${record.revisionDate}')"
                                title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
                tableBody.append(row);
            });
        }

        function escapeQuotes(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function getMovementBadge(revType, productName) {
            // Check if it's an update with stock information
            if (revType === 1 && productName && productName.includes('Stock:')) {
                return '<span class="badge bg-primary"><i class="fas fa-exchange-alt me-1"></i>Movimiento de Stock</span>';
            }

            switch(revType) {
                case 0:
                    return '<span class="badge bg-success"><i class="fas fa-plus me-1"></i>Entrada (Creaci√≥n)</span>';
                case 1:
                    return '<span class="badge bg-warning text-dark"><i class="fas fa-edit me-1"></i>Actualizaci√≥n</span>';
                case 2:
                    return '<span class="badge bg-danger"><i class="fas fa-minus me-1"></i>Salida (Eliminaci√≥n)</span>';
                default:
                    return '<span class="badge bg-secondary"><i class="fas fa-question me-1"></i>Desconocido</span>';
            }
        }

        function formatDateTime(dateTime) {
            if (typeof dateTime === 'string') {
                return dateTime;
            }

            const date = new Date(dateTime);
            return date.toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function updatePaginationInfo(response) {
            totalElements = response.totalElements;
            totalPages = response.totalPages;
            currentPage = response.number;

            const startItem = totalElements > 0 ? (currentPage * pageSize) + 1 : 0;
            const endItem = Math.min((currentPage + 1) * pageSize, totalElements);

            $('#paginationInfo').text(`Mostrando ${startItem} - ${endItem} de ${totalElements} registros`);
            $('#currentPageInput').val(currentPage + 1);
            $('#totalPages').text(totalPages);

            $('#firstPageBtn').prop('disabled', currentPage === 0);
            $('#prevPageBtn').prop('disabled', currentPage === 0);
            $('#nextPageBtn').prop('disabled', currentPage >= totalPages - 1);
            $('#lastPageBtn').prop('disabled', currentPage >= totalPages - 1);

            $('#currentPageInput').attr('max', totalPages);
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            $('#lastUpdated').text(`√öltima actualizaci√≥n: ${formatDateTime(now.getTime())}`);
        }

        function goToPage(pageNumber) {
            if (pageNumber < 0 || pageNumber >= totalPages || pageNumber === currentPage) {
                return;
            }
            currentPage = pageNumber;
            loadMovementData();
        }

        function clearFilters() {
            console.log('Clearing filters...');
            $('#productFilter').val('');
            $('#userFilter').val('');
            $('#movementFilter').val('');
            $('#dateFrom').val('');
            $('#dateTo').val('');
            currentPage = 0;
            loadMovementData();
        }

        function refreshMovementData() {
            console.log('Refreshing movement data...');
            loadMovementData();

            // Show success message if SweetAlert is available
            if (typeof swal !== 'undefined') {
                swal('Actualizado', 'Los datos han sido actualizados', 'success');
            } else {
                // Fallback to basic alert
                alert('Los datos han sido actualizados');
            }
        }

        function toggleFilters() {
            const filtersBody = $('#filtersBody');
            const toggleIcon = $('#filterToggleIcon');

            if (filtersBody.is(':visible')) {
                filtersBody.slideUp(300);
                toggleIcon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
                filtersBody.slideDown(300);
                toggleIcon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        }

        // Make functions globally available for onclick handlers
        window.showMovementDetail = function(revision, productId, productName, revType, username, revisionDate) {
            console.log('Showing movement detail for revision:', revision);

            const modalBody = $('#movementDetailBody');

            // Get movement information
            const movementInfo = getMovementInfo(revType, productName);
            const formattedDate = formatDetailedDateTime(revisionDate);

            // Build modal content
            const modalContent = `
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h6 class="card-title mb-3">
                                <i class="${movementInfo.icon} me-2"></i>
                                ${movementInfo.title}
                            </h6>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Producto</small>
                                    <strong>${productName || 'N/A'}</strong>
                                </div>

                                <div class="col-md-6">
                                    <small class="text-muted d-block">Usuario Responsable</small>
                                    <strong>${username || 'Sistema'}</strong>
                                </div>

                                <div class="col-md-6">
                                    <small class="text-muted d-block">Fecha y Hora</small>
                                    <strong>${formattedDate}</strong>
                                </div>

                                <div class="col-md-6">
                                    <small class="text-muted d-block">Revisi√≥n</small>
                                    <strong>#${revision}</strong>
                                </div>
                            </div>

                            ${movementInfo.stockInfo ? `
                                <hr class="my-3">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Informaci√≥n del Stock:</strong><br>
                                    ${movementInfo.stockInfo}
                                </div>
                            ` : ''}

                            ${movementInfo.description ? `
                                <hr class="my-3">
                                <div class="text-muted">
                                    <small><strong>Descripci√≥n:</strong> ${movementInfo.description}</small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            Registro del sistema de auditor√≠a
                        </small>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadProductHistory(${productId})">
                                <i class="fas fa-history me-1"></i>
                                Ver Historial Completo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            modalBody.html(modalContent);

            // Show modal using Bootstrap 5 API
            const modal = new bootstrap.Modal(document.getElementById('movementDetailModal'));
            modal.show();
        };

        window.loadProductHistory = function(productId) {
            console.log('Loading product history for ID:', productId);

            // Close current modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('movementDetailModal'));
            if (modal) {
                modal.hide();
            }

            // Show info about loading product history
            if (typeof swal !== 'undefined') {
                swal({
                    title: 'Historial del Producto',
                    text: `Mostrando historial completo del producto ID: ${productId}`,
                    icon: 'info',
                    buttons: {
                        cancel: 'Cerrar',
                        confirm: {
                            text: 'Filtrar en la tabla',
                            value: true,
                            visible: true,
                            className: 'btn-primary'
                        }
                    }
                }).then((willFilter) => {
                    if (willFilter) {
                        loadMovementData();
                    }
                });
            } else {
                alert(`Cargando historial del producto ID: ${productId}`);
                loadMovementData();
            }
        };

        function getMovementInfo(revType, productName) {
            let info = {
                icon: 'fas fa-question-circle',
                title: 'Movimiento Desconocido',
                description: '',
                stockInfo: null
            };

            // Detect if there's stock information in the product name
            const stockMatch = productName && productName.match(/Stock:\s*(\d+)\s*‚Üí\s*(\d+)/);

            switch(revType) {
                case 0: // Creation
                    info.icon = 'fas fa-plus-circle text-success';
                    info.title = 'Entrada de Producto (Creaci√≥n)';
                    info.description = 'Se agreg√≥ un nuevo producto al inventario.';

                    if (stockMatch) {
                        info.stockInfo = `Stock inicial registrado: ${stockMatch[2]} unidades`;
                    }
                    break;

                case 1: // Modification
                    info.icon = 'fas fa-edit text-warning';

                    if (stockMatch) {
                        const previousStock = parseInt(stockMatch[1]);
                        const newStock = parseInt(stockMatch[2]);
                        const difference = newStock - previousStock;

                        info.title = 'Movimiento de Inventario';
                        info.description = difference > 0
                            ? 'Se increment√≥ el stock del producto.'
                            : 'Se redujo el stock del producto.';

                        info.stockInfo = `
                        Stock anterior: ${previousStock} unidades<br>
                        Stock actual: ${newStock} unidades<br>
                        <span class="fw-bold ${difference > 0 ? 'text-success' : 'text-danger'}">
                            ${difference > 0 ? '+' : ''}${difference} unidades
                        </span>
                    `;
                    } else {
                        info.title = 'Actualizaci√≥n de Producto';
                        info.description = 'Se modificaron datos del producto (nombre, precio, categor√≠a, etc.)';
                    }
                    break;

                case 2: // Deletion
                    info.icon = 'fas fa-trash text-danger';
                    info.title = 'Salida de Producto (Eliminaci√≥n)';
                    info.description = 'El producto fue eliminado del inventario.';

                    if (stockMatch) {
                        info.stockInfo = `Stock al momento de eliminaci√≥n: ${stockMatch[1]} unidades`;
                    }
                    break;
            }

            return info;
        }

        function formatDetailedDateTime(dateTime) {
            if (typeof dateTime === 'string') {
                const date = new Date(dateTime);
                if (!isNaN(date.getTime())) {
                    return formatDateObject(date);
                }
                return dateTime;
            }

            const date = new Date(dateTime);
            return formatDateObject(date);
        }

        function formatDateObject(date) {
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };

            return date.toLocaleDateString('es-ES', options);
        }

        console.log('Audit script loaded successfully');
    });

    // Additional safety check for jQuery
    if (typeof jQuery === 'undefined') {
        console.error('jQuery failed to load! Please check your network connection or local files.');

        // Show error message to user
        document.addEventListener('DOMContentLoaded', function() {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.innerHTML = `
            <strong>Error:</strong> No se pudo cargar jQuery.
            Por favor, verifica tu conexi√≥n a internet o contacta al administrador del sistema.
        `;

            const container = document.querySelector('.page-inner');
            if (container) {
                container.insertBefore(errorDiv, container.firstChild);
            }
        });
    }
</script>
</body>
</html>